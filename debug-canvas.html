<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas调试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        canvas {
            border: 1px solid #999;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #2980b9;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Canvas图表调试</h1>
    
    <div class="test-section">
        <h2>测试1：正常数据</h2>
        <canvas id="chart1" width="600" height="400"></canvas>
        <br>
        <button onclick="testNormalData()">绘制正常数据</button>
        <div id="data1"></div>
    </div>
    
    <div class="test-section">
        <h2>测试2：空数据</h2>
        <canvas id="chart2" width="600" height="400"></canvas>
        <br>
        <button onclick="testEmptyData()">绘制空数据</button>
        <div id="data2"></div>
    </div>
    
    <div class="test-section">
        <h2>测试3：实际API数据</h2>
        <input type="text" id="surveyId" placeholder="输入Survey ID" style="width: 300px; padding: 8px;">
        <button onclick="testRealData()">获取并绘制真实数据</button>
        <canvas id="chart3" width="600" height="400" style="display: none;"></canvas>
        <div id="data3"></div>
    </div>

    <script>
        // 从admin.html复制的绘图函数
        function drawEmptyChart(ctx, canvas) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('暂无数据', canvas.width / 2, canvas.height / 2);
        }
        
        function drawAxes(ctx, canvas, config, chartWidth, chartHeight) {
            ctx.beginPath();
            ctx.moveTo(config.padding, config.padding);
            ctx.lineTo(config.padding, canvas.height - config.padding);
            ctx.lineTo(canvas.width - config.padding, canvas.height - config.padding);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
        
        function drawGridLines(ctx, canvas, config, chartWidth, chartHeight) {
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            
            for (let i = 0; i <= config.maxValue; i++) {
                const y = canvas.height - config.padding - (i / config.maxValue) * chartHeight;
                ctx.fillText(i.toString(), config.padding - 10, y + 4);
                
                ctx.beginPath();
                ctx.moveTo(config.padding, y);
                ctx.lineTo(canvas.width - config.padding, y);
                ctx.strokeStyle = '#eee';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
        }
        
        function drawBars(ctx, canvas, config, chartWidth, chartHeight, barWidth) {
            config.data.forEach((value, index) => {
                const x = config.padding + (index + 0.5) * (chartWidth / config.dimensions.length) - barWidth / 2;
                const barHeight = (value / config.maxValue) * chartHeight;
                const y = canvas.height - config.padding - barHeight;
                
                ctx.fillStyle = '#3498db';
                ctx.fillRect(x, y, barWidth, barHeight);
                
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value.toFixed(1), x + barWidth / 2, y - 5);
                
                ctx.save();
                ctx.translate(x + barWidth / 2, canvas.height - config.padding + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.textAlign = 'right';
                ctx.fillText(config.dimensions[index], 0, 0);
                ctx.restore();
            });
        }
        
        function drawChart(canvasId, summary) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            if (summary.total_responses === 0) {
                drawEmptyChart(ctx, canvas);
                return;
            }
            
            const chartConfig = {
                dimensions: [
                    '项目进度透明度',
                    '需求响应速度',
                    '团队协作效率',
                    '交付质量稳定性',
                    '问题发现及时性',
                    '资源配置效率',
                    '持续改进能力',
                    '信息传递有效性'
                ],
                data: [
                    summary.avg_project_progress || 0,
                    summary.avg_requirement_response || 0,
                    summary.avg_collaboration || 0,
                    summary.avg_delivery_quality || 0,
                    summary.avg_issue_discovery || 0,
                    summary.avg_resource_allocation || 0,
                    summary.avg_improvement || 0,
                    summary.avg_information_transmission || 0
                ],
                padding: 40,
                maxValue: 5
            };
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const chartWidth = canvas.width - 2 * chartConfig.padding;
            const chartHeight = canvas.height - 2 * chartConfig.padding;
            const barWidth = chartWidth / chartConfig.dimensions.length * 0.8;
            
            drawAxes(ctx, canvas, chartConfig, chartWidth, chartHeight);
            drawGridLines(ctx, canvas, chartConfig, chartWidth, chartHeight);
            drawBars(ctx, canvas, chartConfig, chartWidth, chartHeight, barWidth);
        }
        
        function testNormalData() {
            const summary = {
                total_responses: 4,
                average_overall_score: 3.53125,
                avg_project_progress: 3.75,
                avg_requirement_response: 3.5,
                avg_collaboration: 3.25,
                avg_delivery_quality: 3.75,
                avg_issue_discovery: 3.5,
                avg_resource_allocation: 3.25,
                avg_improvement: 3.75,
                avg_information_transmission: 3.5
            };
            
            document.getElementById('data1').innerHTML = '<pre>' + JSON.stringify(summary, null, 2) + '</pre>';
            drawChart('chart1', summary);
        }
        
        function testEmptyData() {
            const summary = {
                total_responses: 0,
                average_overall_score: null,
                avg_project_progress: null,
                avg_requirement_response: null,
                avg_collaboration: null,
                avg_delivery_quality: null,
                avg_issue_discovery: null,
                avg_resource_allocation: null,
                avg_improvement: null,
                avg_information_transmission: null
            };
            
            document.getElementById('data2').innerHTML = '<pre>' + JSON.stringify(summary, null, 2) + '</pre>';
            drawChart('chart2', summary);
        }
        
        async function testRealData() {
            const surveyId = document.getElementById('surveyId').value;
            if (!surveyId) {
                alert('请输入Survey ID');
                return;
            }
            
            try {
                const response = await fetch(`/api/summary/${surveyId}`);
                const summary = await response.json();
                
                document.getElementById('data3').innerHTML = '<pre>' + JSON.stringify(summary, null, 2) + '</pre>';
                document.getElementById('chart3').style.display = 'block';
                drawChart('chart3', summary);
            } catch (error) {
                document.getElementById('data3').innerHTML = '<p style="color: red;">错误: ' + error.message + '</p>';
            }
        }
        
        // 页面加载时自动测试正常数据
        window.onload = function() {
            testNormalData();
            testEmptyData();
        };
    </script>
</body>
</html>