<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>团队管理效能评估 - 管理后台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', '微软雅黑', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .survey-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .survey-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }
        
        .survey-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .survey-card p {
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .survey-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .stat-card p {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #3498db;
            color: white;
            font-weight: bold;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .create-survey {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .create-survey input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 团队管理效能评估 - 管理后台</h1>
            <p>创建问卷、查看汇总结果、导出数据</p>
        </div>
        
        <!-- 创建新问卷 -->
        <div class="section">
            <h2>📝 创建新问卷</h2>
            <div class="create-survey">
                <input type="text" id="surveyName" placeholder="请输入问卷名称（如：2024年第一季度团队评估）">
                <button class="btn btn-primary" onclick="createSurvey()">创建问卷</button>
            </div>
        </div>
        
        <!-- 问卷列表 -->
        <div class="section">
            <h2>📋 问卷列表</h2>
            <div id="surveyList" class="survey-list">
                <!-- 问卷卡片将在这里动态生成 -->
            </div>
        </div>
        
        <!-- 汇总统计 -->
        <div id="summarySection" class="section hidden">
            <h2>📈 汇总统计</h2>
            <div id="surveyStats" class="survey-stats">
                <!-- 统计卡片将在这里动态生成 -->
            </div>
            <div class="chart-container">
                <h3>各维度平均分</h3>
                <canvas id="summaryChart" class="chart" width="400" height="300"></canvas>
            </div>
        </div>
        
        <!-- 详细数据 -->
        <div id="detailsSection" class="section hidden">
            <h2>📊 详细数据</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="exportData()">导出Excel</button>
            </div>
            <div class="table-container">
                <table id="detailsTable">
                    <thead>
                        <tr>
                            <th>提交时间</th>
                            <th>姓名</th>
                            <th>团队</th>
                            <th>项目进度</th>
                            <th>需求响应</th>
                            <th>团队协作</th>
                            <th>交付质量</th>
                            <th>问题发现</th>
                            <th>资源配置</th>
                            <th>持续改进</th>
                            <th>信息传递</th>
                            <th>总体评分</th>
                            <th>备注</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 数据行将在这里动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentSurveyId = null;
        
        // 检查登录状态
        function checkLogin() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn');
            if (!isLoggedIn) {
                window.location.href = '/admin';
                return false;
            }
            return true;
        }
        
        // 页面加载时获取问卷列表
        window.onload = function() {
            if (!checkLogin()) return;
            loadSurveys();
        };
        
        // 加载问卷列表
        async function loadSurveys() {
            try {
                const response = await fetch('/api/surveys');
                const surveys = await response.json();
                
                const surveyList = document.getElementById('surveyList');
                surveyList.innerHTML = '';
                
                surveys.forEach(survey => {
                    const surveyCard = document.createElement('div');
                    surveyCard.className = 'survey-card';
                    surveyCard.innerHTML = `
                        <h3>${survey.survey_name}</h3>
                        <p>创建时间：${new Date(survey.created_date).toLocaleString()}</p>
                        <p>状态：${survey.is_active ? '活跃' : '已关闭'}</p>
                        <button class="btn btn-primary" onclick="viewResults('${survey.survey_id}', '${survey.survey_name}')">查看结果</button>
                        <button class="btn btn-success" onclick="copyLink('${survey.survey_id}')">复制链接</button>
                        <button class="btn btn-danger" onclick="deleteSurvey('${survey.survey_id}')">删除问卷</button>
                    `;
                    surveyList.appendChild(surveyCard);
                });
            } catch (error) {
                console.error('加载问卷列表失败:', error);
                alert('加载问卷列表失败');
            }
        }
        
        // 创建新问卷
        async function createSurvey() {
            const surveyName = document.getElementById('surveyName').value.trim();
            if (!surveyName) {
                alert('请输入问卷名称');
                return;
            }
            
            try {
                const response = await fetch('/api/surveys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ surveyName })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`问卷创建成功！\n问卷链接：${result.surveyUrl}`);
                    document.getElementById('surveyName').value = '';
                    loadSurveys();
                } else {
                    alert('创建失败：' + result.error);
                }
            } catch (error) {
                console.error('创建问卷失败:', error);
                alert('创建问卷失败');
            }
        }
        
        // 复制问卷链接
        function copyLink(surveyId) {
            const link = `${window.location.origin}/团队管理效能评估轮.html?survey=${surveyId}`;
            navigator.clipboard.writeText(link).then(() => {
                alert('问卷链接已复制到剪贴板！');
            }).catch(() => {
                alert('复制失败，请手动复制链接：' + link);
            });
        }
        
        // 查看结果
        async function viewResults(surveyId, surveyName) {
            currentSurveyId = surveyId;
            
            try {
                // 加载汇总数据
                const summaryResponse = await fetch(`/api/summary/${surveyId}`);
                const summary = await summaryResponse.json();
                
                // 显示汇总统计
                document.getElementById('summarySection').classList.remove('hidden');
                document.getElementById('detailsSection').classList.remove('hidden');
                
                // 生成统计卡片
                const surveyStats = document.getElementById('surveyStats');
                surveyStats.innerHTML = `
                    <div class="stat-card">
                        <h3>${summary.total_responses}</h3>
                        <p>总响应数</p>
                    </div>
                    <div class="stat-card">
                        <h3>${summary.average_overall_score ? summary.average_overall_score.toFixed(1) : '0'}</h3>
                        <p>平均总体评分</p>
                    </div>
                `;
                
                // 绘制图表
                drawChart(summary);
                
                // 加载详细数据
                loadDetails(surveyId);
                
            } catch (error) {
                console.error('加载结果失败:', error);
                alert('加载结果失败');
            }
        }
        
        // 绘制图表
        function drawChart(summary) {
            const canvas = document.getElementById('summaryChart');
            const ctx = canvas.getContext('2d');
            
            const dimensions = [
                '项目进度透明度',
                '需求响应速度',
                '团队协作效率',
                '交付质量稳定性',
                '问题发现及时性',
                '资源配置效率',
                '持续改进能力',
                '信息传递有效性'
            ];
            
            const data = [
                summary.avg_project_progress || 0,
                summary.avg_requirement_response || 0,
                summary.avg_collaboration || 0,
                summary.avg_delivery_quality || 0,
                summary.avg_issue_discovery || 0,
                summary.avg_resource_allocation || 0,
                summary.avg_improvement || 0,
                summary.avg_information_transmission || 0
            ];
            
            // 清除画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 设置图表参数
            const padding = 40;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            const barWidth = chartWidth / dimensions.length * 0.8;
            const maxValue = 5;
            
            // 绘制坐标轴
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // 绘制Y轴刻度
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= maxValue; i++) {
                const y = canvas.height - padding - (i / maxValue) * chartHeight;
                ctx.fillText(i.toString(), padding - 10, y + 4);
                
                // 绘制网格线
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.strokeStyle = '#eee';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
            
            // 绘制柱状图
            data.forEach((value, index) => {
                const x = padding + (index + 0.5) * (chartWidth / dimensions.length) - barWidth / 2;
                const barHeight = (value / maxValue) * chartHeight;
                const y = canvas.height - padding - barHeight;
                
                // 绘制柱子
                ctx.fillStyle = '#3498db';
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // 绘制数值
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value.toFixed(1), x + barWidth / 2, y - 5);
                
                // 绘制标签
                ctx.save();
                ctx.translate(x + barWidth / 2, canvas.height - padding + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.textAlign = 'right';
                ctx.fillText(dimensions[index], 0, 0);
                ctx.restore();
            });
        }
        
        // 加载详细数据
        async function loadDetails(surveyId) {
            try {
                const response = await fetch(`/api/assessments/${surveyId}`);
                const assessments = await response.json();
                
                const tbody = document.querySelector('#detailsTable tbody');
                tbody.innerHTML = '';
                
                assessments.forEach(assessment => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(assessment.submission_date).toLocaleString()}</td>
                        <td>${assessment.respondent_name}</td>
                        <td>${assessment.respondent_team || '-'}</td>
                        <td>${assessment.project_progress_transparency}</td>
                        <td>${assessment.requirement_response_speed}</td>
                        <td>${assessment.team_collaboration_efficiency}</td>
                        <td>${assessment.delivery_quality_stability}</td>
                        <td>${assessment.issue_discovery_timeliness}</td>
                        <td>${assessment.resource_allocation_efficiency}</td>
                        <td>${assessment.continuous_improvement_ability}</td>
                        <td>${assessment.information_transmission_effectiveness}</td>
                        <td>${assessment.overall_score.toFixed(1)}</td>
                        <td>${assessment.notes || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('加载详细数据失败:', error);
                alert('加载详细数据失败');
            }
        }
        
        // 删除问卷
        async function deleteSurvey(surveyId) {
            if (!confirm('确定要删除这个问卷及其所有数据吗？此操作不可恢复！')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/surveys/${surveyId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('问卷删除成功！');
                    loadSurveys(); // 重新加载问卷列表
                    // 如果当前正在查看被删除的问卷，清空显示
                    if (currentSurveyId === surveyId) {
                        currentSurveyId = null;
                        document.getElementById('summarySection').classList.add('hidden');
                        document.getElementById('detailsSection').classList.add('hidden');
                    }
                } else {
                    const error = await response.json();
                    alert('删除失败：' + (error.error || '未知错误'));
                }
            } catch (error) {
                console.error('删除问卷失败:', error);
                alert('删除问卷失败，请重试');
            }
        }
        
        // 导出数据
        function exportData() {
            if (!currentSurveyId) {
                alert('请先选择一个问卷');
                return;
            }
            
            window.location.href = `/api/export/${currentSurveyId}`;
        }
    </script>
</body>
</html>