<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¢é˜Ÿç®¡ç†æ•ˆèƒ½è¯„ä¼° - ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', 'å¾®è½¯é›…é»‘', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .survey-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .survey-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }
        
        .survey-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .survey-card p {
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .survey-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .stat-card p {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #3498db;
            color: white;
            font-weight: bold;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .create-survey {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .create-survey input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š å›¢é˜Ÿç®¡ç†æ•ˆèƒ½è¯„ä¼° - ç®¡ç†åå°</h1>
            <p>åˆ›å»ºé—®å·ã€æŸ¥çœ‹æ±‡æ€»ç»“æœã€å¯¼å‡ºæ•°æ®</p>
        </div>
        
        <!-- åˆ›å»ºæ–°é—®å· -->
        <div class="section">
            <h2>ğŸ“ åˆ›å»ºæ–°é—®å·</h2>
            <div class="create-survey">
                <input type="text" id="surveyName" placeholder="è¯·è¾“å…¥é—®å·åç§°ï¼ˆå¦‚ï¼š2024å¹´ç¬¬ä¸€å­£åº¦å›¢é˜Ÿè¯„ä¼°ï¼‰">
                <button class="btn btn-primary" onclick="createSurvey()">åˆ›å»ºé—®å·</button>
            </div>
        </div>
        
        <!-- é—®å·åˆ—è¡¨ -->
        <div class="section">
            <h2>ğŸ“‹ é—®å·åˆ—è¡¨</h2>
            <div id="surveyList" class="survey-list">
                <!-- é—®å·å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- æ±‡æ€»ç»Ÿè®¡ -->
        <div id="summarySection" class="section hidden">
            <h2>ğŸ“ˆ æ±‡æ€»ç»Ÿè®¡</h2>
            <div id="surveyStats" class="survey-stats">
                <!-- ç»Ÿè®¡å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="chart-container">
                <h3>å„ç»´åº¦å¹³å‡åˆ†</h3>
                <canvas id="summaryChart" class="chart" width="400" height="300"></canvas>
            </div>
        </div>
        
        <!-- è¯¦ç»†æ•°æ® -->
        <div id="detailsSection" class="section hidden">
            <h2>ğŸ“Š è¯¦ç»†æ•°æ®</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="exportData()">å¯¼å‡ºExcel</button>
            </div>
            <div class="table-container">
                <table id="detailsTable">
                    <thead>
                        <tr>
                            <th>æäº¤æ—¶é—´</th>
                            <th>å§“å</th>
                            <th>å›¢é˜Ÿ</th>
                            <th>é¡¹ç›®è¿›åº¦</th>
                            <th>éœ€æ±‚å“åº”</th>
                            <th>å›¢é˜Ÿåä½œ</th>
                            <th>äº¤ä»˜è´¨é‡</th>
                            <th>é—®é¢˜å‘ç°</th>
                            <th>èµ„æºé…ç½®</th>
                            <th>æŒç»­æ”¹è¿›</th>
                            <th>ä¿¡æ¯ä¼ é€’</th>
                            <th>æ€»ä½“è¯„åˆ†</th>
                            <th>å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- æ•°æ®è¡Œå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentSurveyId = null;
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLogin() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn');
            if (!isLoggedIn) {
                window.location.href = '/admin';
                return false;
            }
            return true;
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–é—®å·åˆ—è¡¨
        window.onload = function() {
            if (!checkLogin()) return;
            loadSurveys();
        };
        
        // åŠ è½½é—®å·åˆ—è¡¨
        async function loadSurveys() {
            try {
                const response = await fetch('/api/surveys');
                const surveys = await response.json();
                
                const surveyList = document.getElementById('surveyList');
                surveyList.innerHTML = '';
                
                surveys.forEach(survey => {
                    const surveyCard = document.createElement('div');
                    surveyCard.className = 'survey-card';
                    surveyCard.innerHTML = `
                        <h3>${survey.survey_name}</h3>
                        <p>åˆ›å»ºæ—¶é—´ï¼š${new Date(survey.created_date).toLocaleString()}</p>
                        <p>çŠ¶æ€ï¼š${survey.is_active ? 'æ´»è·ƒ' : 'å·²å…³é—­'}</p>
                        <button class="btn btn-primary" onclick="viewResults('${survey.survey_id}', '${survey.survey_name}')">æŸ¥çœ‹ç»“æœ</button>
                        <button class="btn btn-success" onclick="copyLink('${survey.survey_id}')">å¤åˆ¶é“¾æ¥</button>
                        <button class="btn btn-danger" onclick="deleteSurvey('${survey.survey_id}')">åˆ é™¤é—®å·</button>
                    `;
                    surveyList.appendChild(surveyCard);
                });
            } catch (error) {
                console.error('åŠ è½½é—®å·åˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½é—®å·åˆ—è¡¨å¤±è´¥');
            }
        }
        
        // åˆ›å»ºæ–°é—®å·
        async function createSurvey() {
            const surveyName = document.getElementById('surveyName').value.trim();
            if (!surveyName) {
                alert('è¯·è¾“å…¥é—®å·åç§°');
                return;
            }
            
            try {
                const response = await fetch('/api/surveys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ surveyName })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`é—®å·åˆ›å»ºæˆåŠŸï¼\né—®å·é“¾æ¥ï¼š${result.surveyUrl}`);
                    document.getElementById('surveyName').value = '';
                    loadSurveys();
                } else {
                    alert('åˆ›å»ºå¤±è´¥ï¼š' + result.error);
                }
            } catch (error) {
                console.error('åˆ›å»ºé—®å·å¤±è´¥:', error);
                alert('åˆ›å»ºé—®å·å¤±è´¥');
            }
        }
        
        // å¤åˆ¶é—®å·é“¾æ¥
        function copyLink(surveyId) {
            const link = `${window.location.origin}/å›¢é˜Ÿç®¡ç†æ•ˆèƒ½è¯„ä¼°è½®.html?survey=${surveyId}`;
            navigator.clipboard.writeText(link).then(() => {
                alert('é—®å·é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(() => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥ï¼š' + link);
            });
        }
        
        // æŸ¥çœ‹ç»“æœ
        async function viewResults(surveyId, surveyName) {
            currentSurveyId = surveyId;
            
            try {
                // åŠ è½½æ±‡æ€»æ•°æ®
                const summaryResponse = await fetch(`/api/summary/${surveyId}`);
                const summary = await summaryResponse.json();
                
                // æ˜¾ç¤ºæ±‡æ€»ç»Ÿè®¡
                document.getElementById('summarySection').classList.remove('hidden');
                document.getElementById('detailsSection').classList.remove('hidden');
                
                // ç”Ÿæˆç»Ÿè®¡å¡ç‰‡
                const surveyStats = document.getElementById('surveyStats');
                surveyStats.innerHTML = `
                    <div class="stat-card">
                        <h3>${summary.total_responses}</h3>
                        <p>æ€»å“åº”æ•°</p>
                    </div>
                    <div class="stat-card">
                        <h3>${summary.average_overall_score ? summary.average_overall_score.toFixed(1) : '0'}</h3>
                        <p>å¹³å‡æ€»ä½“è¯„åˆ†</p>
                    </div>
                `;
                
                // ç»˜åˆ¶å›¾è¡¨
                drawChart(summary);
                
                // åŠ è½½è¯¦ç»†æ•°æ®
                loadDetails(surveyId);
                
            } catch (error) {
                console.error('åŠ è½½ç»“æœå¤±è´¥:', error);
                alert('åŠ è½½ç»“æœå¤±è´¥');
            }
        }
        
        // ç»˜åˆ¶å›¾è¡¨
        function drawChart(summary) {
            const canvas = document.getElementById('summaryChart');
            const ctx = canvas.getContext('2d');
            
            const dimensions = [
                'é¡¹ç›®è¿›åº¦é€æ˜åº¦',
                'éœ€æ±‚å“åº”é€Ÿåº¦',
                'å›¢é˜Ÿåä½œæ•ˆç‡',
                'äº¤ä»˜è´¨é‡ç¨³å®šæ€§',
                'é—®é¢˜å‘ç°åŠæ—¶æ€§',
                'èµ„æºé…ç½®æ•ˆç‡',
                'æŒç»­æ”¹è¿›èƒ½åŠ›',
                'ä¿¡æ¯ä¼ é€’æœ‰æ•ˆæ€§'
            ];
            
            const data = [
                summary.avg_project_progress || 0,
                summary.avg_requirement_response || 0,
                summary.avg_collaboration || 0,
                summary.avg_delivery_quality || 0,
                summary.avg_issue_discovery || 0,
                summary.avg_resource_allocation || 0,
                summary.avg_improvement || 0,
                summary.avg_information_transmission || 0
            ];
            
            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // è®¾ç½®å›¾è¡¨å‚æ•°
            const padding = 40;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            const barWidth = chartWidth / dimensions.length * 0.8;
            const maxValue = 5;
            
            // ç»˜åˆ¶åæ ‡è½´
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // ç»˜åˆ¶Yè½´åˆ»åº¦
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= maxValue; i++) {
                const y = canvas.height - padding - (i / maxValue) * chartHeight;
                ctx.fillText(i.toString(), padding - 10, y + 4);
                
                // ç»˜åˆ¶ç½‘æ ¼çº¿
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.strokeStyle = '#eee';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
            
            // ç»˜åˆ¶æŸ±çŠ¶å›¾
            data.forEach((value, index) => {
                const x = padding + (index + 0.5) * (chartWidth / dimensions.length) - barWidth / 2;
                const barHeight = (value / maxValue) * chartHeight;
                const y = canvas.height - padding - barHeight;
                
                // ç»˜åˆ¶æŸ±å­
                ctx.fillStyle = '#3498db';
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // ç»˜åˆ¶æ•°å€¼
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value.toFixed(1), x + barWidth / 2, y - 5);
                
                // ç»˜åˆ¶æ ‡ç­¾
                ctx.save();
                ctx.translate(x + barWidth / 2, canvas.height - padding + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.textAlign = 'right';
                ctx.fillText(dimensions[index], 0, 0);
                ctx.restore();
            });
        }
        
        // åŠ è½½è¯¦ç»†æ•°æ®
        async function loadDetails(surveyId) {
            try {
                const response = await fetch(`/api/assessments/${surveyId}`);
                const assessments = await response.json();
                
                const tbody = document.querySelector('#detailsTable tbody');
                tbody.innerHTML = '';
                
                assessments.forEach(assessment => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(assessment.submission_date).toLocaleString()}</td>
                        <td>${assessment.respondent_name}</td>
                        <td>${assessment.respondent_team || '-'}</td>
                        <td>${assessment.project_progress_transparency}</td>
                        <td>${assessment.requirement_response_speed}</td>
                        <td>${assessment.team_collaboration_efficiency}</td>
                        <td>${assessment.delivery_quality_stability}</td>
                        <td>${assessment.issue_discovery_timeliness}</td>
                        <td>${assessment.resource_allocation_efficiency}</td>
                        <td>${assessment.continuous_improvement_ability}</td>
                        <td>${assessment.information_transmission_effectiveness}</td>
                        <td>${assessment.overall_score.toFixed(1)}</td>
                        <td>${assessment.notes || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('åŠ è½½è¯¦ç»†æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½è¯¦ç»†æ•°æ®å¤±è´¥');
            }
        }
        
        // åˆ é™¤é—®å·
        async function deleteSurvey(surveyId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé—®å·åŠå…¶æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/surveys/${surveyId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('é—®å·åˆ é™¤æˆåŠŸï¼');
                    loadSurveys(); // é‡æ–°åŠ è½½é—®å·åˆ—è¡¨
                    // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¢«åˆ é™¤çš„é—®å·ï¼Œæ¸…ç©ºæ˜¾ç¤º
                    if (currentSurveyId === surveyId) {
                        currentSurveyId = null;
                        document.getElementById('summarySection').classList.add('hidden');
                        document.getElementById('detailsSection').classList.add('hidden');
                    }
                } else {
                    const error = await response.json();
                    alert('åˆ é™¤å¤±è´¥ï¼š' + (error.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤é—®å·å¤±è´¥:', error);
                alert('åˆ é™¤é—®å·å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (!currentSurveyId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé—®å·');
                return;
            }
            
            window.location.href = `/api/export/${currentSurveyId}`;
        }
    </script>
</body>
</html>