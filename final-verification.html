<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆåŠŸèƒ½éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f7;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        canvas {
            border: 1px solid #ddd;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ å›¢é˜Ÿç®¡ç†æ•ˆèƒ½è¯„ä¼°ç³»ç»Ÿ - æœ€ç»ˆéªŒè¯</h1>
        
        <div class="section">
            <h2>1. åˆ›å»ºæµ‹è¯•é—®å·</h2>
            <input type="text" id="surveyName" placeholder="è¾“å…¥é—®å·åç§°" style="width: 300px; padding: 8px; margin-right: 10px;">
            <button class="btn btn-primary" onclick="createTestSurvey()">åˆ›å»ºé—®å·</button>
            <div id="createStatus"></div>
        </div>
        
        <div class="section">
            <h2>2. æäº¤æµ‹è¯•æ•°æ®</h2>
            <button class="btn btn-success" onclick="submitTestData()">æäº¤æµ‹è¯•è¯„ä¼°æ•°æ®</button>
            <div id="submitStatus"></div>
        </div>
        
        <div class="section">
            <h2>3. éªŒè¯åå°æ˜¾ç¤º</h2>
            <button class="btn btn-primary" onclick="verifyAdminDisplay()">éªŒè¯æ±‡æ€»ç»Ÿè®¡</button>
            <div id="verifyStatus"></div>
            <canvas id="testChart" width="600" height="400"></canvas>
            <div id="chartData"></div>
        </div>
        
        <div class="section">
            <h2>4. å®Œæ•´æµç¨‹æµ‹è¯•ç»“æœ</h2>
            <div id="finalResult"></div>
        </div>
    </div>

    <script>
        let testSurveyId = null;
        
        // åˆ›å»ºæµ‹è¯•é—®å·
        async function createTestSurvey() {
            const surveyName = document.getElementById('surveyName').value || 'åŠŸèƒ½éªŒè¯æµ‹è¯•é—®å·';
            const statusDiv = document.getElementById('createStatus');
            
            try {
                const response = await fetch('/api/surveys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ surveyName })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    testSurveyId = result.surveyId;
                    statusDiv.innerHTML = `<div class="success">âœ… é—®å·åˆ›å»ºæˆåŠŸï¼ID: ${testSurveyId}</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="error">âŒ åˆ›å»ºå¤±è´¥: ${result.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            }
        }
        
        // æäº¤æµ‹è¯•æ•°æ®
        async function submitTestData() {
            if (!testSurveyId) {
                document.getElementById('submitStatus').innerHTML = 
                    '<div class="error">âŒ è¯·å…ˆåˆ›å»ºé—®å·</div>';
                return;
            }
            
            const statusDiv = document.getElementById('submitStatus');
            
            // æµ‹è¯•æ•°æ®
            const testData = [
                {
                    surveyId: testSurveyId,
                    respondentName: 'æµ‹è¯•ç”¨æˆ·1',
                    respondentTeam: 'ç ”å‘å›¢é˜Ÿ',
                    scores: [5, 4, 4, 5, 3, 4, 5, 4],
                    notes: 'ç¬¬ä¸€æ¬¡æµ‹è¯•è¯„ä¼°'
                },
                {
                    surveyId: testSurveyId,
                    respondentName: 'æµ‹è¯•ç”¨æˆ·2',
                    respondentTeam: 'äº§å“å›¢é˜Ÿ',
                    scores: [4, 5, 3, 4, 5, 3, 4, 5],
                    notes: 'ç¬¬äºŒæ¬¡æµ‹è¯•è¯„ä¼°'
                },
                {
                    surveyId: testSurveyId,
                    respondentName: 'æµ‹è¯•ç”¨æˆ·3',
                    respondentTeam: 'è®¾è®¡å›¢é˜Ÿ',
                    scores: [5, 5, 4, 5, 4, 4, 5, 5],
                    notes: 'ç¬¬ä¸‰æ¬¡æµ‹è¯•è¯„ä¼°'
                }
            ];
            
            let successCount = 0;
            
            for (const data of testData) {
                try {
                    const response = await fetch('/api/assessments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        successCount++;
                    }
                } catch (error) {
                    console.error('æäº¤å¤±è´¥:', error);
                }
            }
            
            statusDiv.innerHTML = 
                `<div class="success">âœ… æˆåŠŸæäº¤ ${successCount}/${testData.length} æ¡è¯„ä¼°æ•°æ®</div>`;
        }
        
        // éªŒè¯åå°æ˜¾ç¤º
        async function verifyAdminDisplay() {
            if (!testSurveyId) {
                document.getElementById('verifyStatus').innerHTML = 
                    '<div class="error">âŒ è¯·å…ˆåˆ›å»ºé—®å·å¹¶æäº¤æ•°æ®</div>';
                return;
            }
            
            const statusDiv = document.getElementById('verifyStatus');
            const dataDiv = document.getElementById('chartData');
            
            try {
                // è·å–æ±‡æ€»æ•°æ®
                const summaryResponse = await fetch(`/api/summary/${testSurveyId}`);
                const summary = await summaryResponse.json();
                
                // æ˜¾ç¤ºæ•°æ®
                dataDiv.innerHTML = '<h3>åç«¯è¿”å›çš„æ±‡æ€»æ•°æ®ï¼š</h3>' +
                    '<pre>' + JSON.stringify(summary, null, 2) + '</pre>';
                
                // ç»˜åˆ¶å›¾è¡¨
                drawTestChart(summary);
                
                // éªŒè¯å„ç»´åº¦æ•°æ®
                const dimensions = [
                    'avg_project_progress',
                    'avg_requirement_response',
                    'avg_collaboration',
                    'avg_delivery_quality',
                    'avg_issue_discovery',
                    'avg_resource_allocation',
                    'avg_improvement',
                    'avg_information_transmission'
                ];
                
                let allValid = true;
                dimensions.forEach(dim => {
                    if (summary[dim] === null || summary[dim] === undefined) {
                        allValid = false;
                    }
                });
                
                if (allValid && summary.total_responses > 0) {
                    statusDiv.innerHTML = 
                        '<div class="success">âœ… æ±‡æ€»æ•°æ®éªŒè¯é€šè¿‡ï¼æ‰€æœ‰ç»´åº¦éƒ½æœ‰æ­£ç¡®çš„å¹³å‡å€¼</div>';
                    
                    // æ›´æ–°æœ€ç»ˆç»“æœ
                    updateFinalResult(true);
                } else {
                    statusDiv.innerHTML = 
                        '<div class="error">âŒ æ±‡æ€»æ•°æ®éªŒè¯å¤±è´¥</div>';
                    updateFinalResult(false);
                }
                
            } catch (error) {
                statusDiv.innerHTML = 
                    `<div class="error">âŒ éªŒè¯å¤±è´¥: ${error.message}</div>`;
                updateFinalResult(false);
            }
        }
        
        // ç»˜åˆ¶æµ‹è¯•å›¾è¡¨
        function drawTestChart(summary) {
            const canvas = document.getElementById('testChart');
            const ctx = canvas.getContext('2d');
            
            if (summary.total_responses === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ•°æ®', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const chartConfig = {
                dimensions: [
                    'é¡¹ç›®è¿›åº¦é€æ˜åº¦',
                    'éœ€æ±‚å“åº”é€Ÿåº¦',
                    'å›¢é˜Ÿåä½œæ•ˆç‡',
                    'äº¤ä»˜è´¨é‡ç¨³å®šæ€§',
                    'é—®é¢˜å‘ç°åŠæ—¶æ€§',
                    'èµ„æºé…ç½®æ•ˆç‡',
                    'æŒç»­æ”¹è¿›èƒ½åŠ›',
                    'ä¿¡æ¯ä¼ é€’æœ‰æ•ˆæ€§'
                ],
                data: [
                    summary.avg_project_progress || 0,
                    summary.avg_requirement_response || 0,
                    summary.avg_collaboration || 0,
                    summary.avg_delivery_quality || 0,
                    summary.avg_issue_discovery || 0,
                    summary.avg_resource_allocation || 0,
                    summary.avg_improvement || 0,
                    summary.avg_information_transmission || 0
                ],
                padding: 40,
                maxValue: 5
            };
            
            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const chartWidth = canvas.width - 2 * chartConfig.padding;
            const chartHeight = canvas.height - 2 * chartConfig.padding;
            const barWidth = chartWidth / chartConfig.dimensions.length * 0.8;
            
            // ç»˜åˆ¶åæ ‡è½´
            ctx.beginPath();
            ctx.moveTo(chartConfig.padding, chartConfig.padding);
            ctx.lineTo(chartConfig.padding, canvas.height - chartConfig.padding);
            ctx.lineTo(canvas.width - chartConfig.padding, canvas.height - chartConfig.padding);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // ç»˜åˆ¶ç½‘æ ¼çº¿å’Œåˆ»åº¦
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            
            for (let i = 0; i <= chartConfig.maxValue; i++) {
                const y = canvas.height - chartConfig.padding - (i / chartConfig.maxValue) * chartHeight;
                ctx.fillText(i.toString(), chartConfig.padding - 10, y + 4);
                
                ctx.beginPath();
                ctx.moveTo(chartConfig.padding, y);
                ctx.lineTo(canvas.width - chartConfig.padding, y);
                ctx.strokeStyle = '#eee';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
            
            // ç»˜åˆ¶æŸ±çŠ¶å›¾
            chartConfig.data.forEach((value, index) => {
                const x = chartConfig.padding + (index + 0.5) * (chartWidth / chartConfig.dimensions.length) - barWidth / 2;
                const barHeight = (value / chartConfig.maxValue) * chartHeight;
                const y = canvas.height - chartConfig.padding - barHeight;
                
                // ç»˜åˆ¶æŸ±å­
                ctx.fillStyle = '#3498db';
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // ç»˜åˆ¶æ•°å€¼
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value.toFixed(1), x + barWidth / 2, y - 5);
                
                // ç»˜åˆ¶æ ‡ç­¾
                ctx.save();
                ctx.translate(x + barWidth / 2, canvas.height - chartConfig.padding + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.textAlign = 'right';
                ctx.fillText(chartConfig.dimensions[index], 0, 0);
                ctx.restore();
            });
        }
        
        // æ›´æ–°æœ€ç»ˆç»“æœ
        function updateFinalResult(success) {
            const resultDiv = document.getElementById('finalResult');
            
            if (success) {
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>ğŸ‰ æ‰€æœ‰åŠŸèƒ½éªŒè¯é€šè¿‡ï¼</h3>
                        <ul>
                            <li>âœ… é—®å·åˆ›å»ºåŠŸèƒ½æ­£å¸¸</li>
                            <li>âœ… æ•°æ®æäº¤åŠŸèƒ½æ­£å¸¸</li>
                            <li>âœ… åå°æ±‡æ€»ç»Ÿè®¡æ­£å¸¸</li>
                            <li>âœ… å„ç»´åº¦å¹³å‡åˆ†è®¡ç®—æ­£ç¡®</li>
                            <li>âœ… Canvaså›¾è¡¨æ¸²æŸ“æ­£å¸¸</li>
                        </ul>
                        <p><strong>ç³»ç»Ÿå·²ä¿®å¤å®Œæ¯•ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼</strong></p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>âŒ åŠŸèƒ½éªŒè¯å¤±è´¥</h3>
                        <p>è¯·æ£€æŸ¥ä¸Šè¿°æ­¥éª¤çš„é”™è¯¯ä¿¡æ¯</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>