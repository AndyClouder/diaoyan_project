<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最终功能验证</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f7;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        canvas {
            border: 1px solid #ddd;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 团队管理效能评估系统 - 最终验证</h1>
        
        <div class="section">
            <h2>1. 创建测试问卷</h2>
            <input type="text" id="surveyName" placeholder="输入问卷名称" style="width: 300px; padding: 8px; margin-right: 10px;">
            <button class="btn btn-primary" onclick="createTestSurvey()">创建问卷</button>
            <div id="createStatus"></div>
        </div>
        
        <div class="section">
            <h2>2. 提交测试数据</h2>
            <button class="btn btn-success" onclick="submitTestData()">提交测试评估数据</button>
            <div id="submitStatus"></div>
        </div>
        
        <div class="section">
            <h2>3. 验证后台显示</h2>
            <button class="btn btn-primary" onclick="verifyAdminDisplay()">验证汇总统计</button>
            <div id="verifyStatus"></div>
            <canvas id="testChart" width="600" height="400"></canvas>
            <div id="chartData"></div>
        </div>
        
        <div class="section">
            <h2>4. 完整流程测试结果</h2>
            <div id="finalResult"></div>
        </div>
    </div>

    <script>
        let testSurveyId = null;
        
        // 创建测试问卷
        async function createTestSurvey() {
            const surveyName = document.getElementById('surveyName').value || '功能验证测试问卷';
            const statusDiv = document.getElementById('createStatus');
            
            try {
                const response = await fetch('/api/surveys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ surveyName })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    testSurveyId = result.surveyId;
                    statusDiv.innerHTML = `<div class="success">✅ 问卷创建成功！ID: ${testSurveyId}</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="error">❌ 创建失败: ${result.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">❌ 网络错误: ${error.message}</div>`;
            }
        }
        
        // 提交测试数据
        async function submitTestData() {
            if (!testSurveyId) {
                document.getElementById('submitStatus').innerHTML = 
                    '<div class="error">❌ 请先创建问卷</div>';
                return;
            }
            
            const statusDiv = document.getElementById('submitStatus');
            
            // 测试数据
            const testData = [
                {
                    surveyId: testSurveyId,
                    respondentName: '测试用户1',
                    respondentTeam: '研发团队',
                    scores: [5, 4, 4, 5, 3, 4, 5, 4],
                    notes: '第一次测试评估'
                },
                {
                    surveyId: testSurveyId,
                    respondentName: '测试用户2',
                    respondentTeam: '产品团队',
                    scores: [4, 5, 3, 4, 5, 3, 4, 5],
                    notes: '第二次测试评估'
                },
                {
                    surveyId: testSurveyId,
                    respondentName: '测试用户3',
                    respondentTeam: '设计团队',
                    scores: [5, 5, 4, 5, 4, 4, 5, 5],
                    notes: '第三次测试评估'
                }
            ];
            
            let successCount = 0;
            
            for (const data of testData) {
                try {
                    const response = await fetch('/api/assessments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        successCount++;
                    }
                } catch (error) {
                    console.error('提交失败:', error);
                }
            }
            
            statusDiv.innerHTML = 
                `<div class="success">✅ 成功提交 ${successCount}/${testData.length} 条评估数据</div>`;
        }
        
        // 验证后台显示
        async function verifyAdminDisplay() {
            if (!testSurveyId) {
                document.getElementById('verifyStatus').innerHTML = 
                    '<div class="error">❌ 请先创建问卷并提交数据</div>';
                return;
            }
            
            const statusDiv = document.getElementById('verifyStatus');
            const dataDiv = document.getElementById('chartData');
            
            try {
                // 获取汇总数据
                const summaryResponse = await fetch(`/api/summary/${testSurveyId}`);
                const summary = await summaryResponse.json();
                
                // 显示数据
                dataDiv.innerHTML = '<h3>后端返回的汇总数据：</h3>' +
                    '<pre>' + JSON.stringify(summary, null, 2) + '</pre>';
                
                // 绘制图表
                drawTestChart(summary);
                
                // 验证各维度数据
                const dimensions = [
                    'avg_project_progress',
                    'avg_requirement_response',
                    'avg_collaboration',
                    'avg_delivery_quality',
                    'avg_issue_discovery',
                    'avg_resource_allocation',
                    'avg_improvement',
                    'avg_information_transmission'
                ];
                
                let allValid = true;
                dimensions.forEach(dim => {
                    if (summary[dim] === null || summary[dim] === undefined) {
                        allValid = false;
                    }
                });
                
                if (allValid && summary.total_responses > 0) {
                    statusDiv.innerHTML = 
                        '<div class="success">✅ 汇总数据验证通过！所有维度都有正确的平均值</div>';
                    
                    // 更新最终结果
                    updateFinalResult(true);
                } else {
                    statusDiv.innerHTML = 
                        '<div class="error">❌ 汇总数据验证失败</div>';
                    updateFinalResult(false);
                }
                
            } catch (error) {
                statusDiv.innerHTML = 
                    `<div class="error">❌ 验证失败: ${error.message}</div>`;
                updateFinalResult(false);
            }
        }
        
        // 绘制测试图表
        function drawTestChart(summary) {
            const canvas = document.getElementById('testChart');
            const ctx = canvas.getContext('2d');
            
            if (summary.total_responses === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('暂无数据', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const chartConfig = {
                dimensions: [
                    '项目进度透明度',
                    '需求响应速度',
                    '团队协作效率',
                    '交付质量稳定性',
                    '问题发现及时性',
                    '资源配置效率',
                    '持续改进能力',
                    '信息传递有效性'
                ],
                data: [
                    summary.avg_project_progress || 0,
                    summary.avg_requirement_response || 0,
                    summary.avg_collaboration || 0,
                    summary.avg_delivery_quality || 0,
                    summary.avg_issue_discovery || 0,
                    summary.avg_resource_allocation || 0,
                    summary.avg_improvement || 0,
                    summary.avg_information_transmission || 0
                ],
                padding: 40,
                maxValue: 5
            };
            
            // 清除画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const chartWidth = canvas.width - 2 * chartConfig.padding;
            const chartHeight = canvas.height - 2 * chartConfig.padding;
            const barWidth = chartWidth / chartConfig.dimensions.length * 0.8;
            
            // 绘制坐标轴
            ctx.beginPath();
            ctx.moveTo(chartConfig.padding, chartConfig.padding);
            ctx.lineTo(chartConfig.padding, canvas.height - chartConfig.padding);
            ctx.lineTo(canvas.width - chartConfig.padding, canvas.height - chartConfig.padding);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // 绘制网格线和刻度
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            
            for (let i = 0; i <= chartConfig.maxValue; i++) {
                const y = canvas.height - chartConfig.padding - (i / chartConfig.maxValue) * chartHeight;
                ctx.fillText(i.toString(), chartConfig.padding - 10, y + 4);
                
                ctx.beginPath();
                ctx.moveTo(chartConfig.padding, y);
                ctx.lineTo(canvas.width - chartConfig.padding, y);
                ctx.strokeStyle = '#eee';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
            
            // 绘制柱状图
            chartConfig.data.forEach((value, index) => {
                const x = chartConfig.padding + (index + 0.5) * (chartWidth / chartConfig.dimensions.length) - barWidth / 2;
                const barHeight = (value / chartConfig.maxValue) * chartHeight;
                const y = canvas.height - chartConfig.padding - barHeight;
                
                // 绘制柱子
                ctx.fillStyle = '#3498db';
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // 绘制数值
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value.toFixed(1), x + barWidth / 2, y - 5);
                
                // 绘制标签
                ctx.save();
                ctx.translate(x + barWidth / 2, canvas.height - chartConfig.padding + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.textAlign = 'right';
                ctx.fillText(chartConfig.dimensions[index], 0, 0);
                ctx.restore();
            });
        }
        
        // 更新最终结果
        function updateFinalResult(success) {
            const resultDiv = document.getElementById('finalResult');
            
            if (success) {
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>🎉 所有功能验证通过！</h3>
                        <ul>
                            <li>✅ 问卷创建功能正常</li>
                            <li>✅ 数据提交功能正常</li>
                            <li>✅ 后台汇总统计正常</li>
                            <li>✅ 各维度平均分计算正确</li>
                            <li>✅ Canvas图表渲染正常</li>
                        </ul>
                        <p><strong>系统已修复完毕，可以正常使用！</strong></p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ 功能验证失败</h3>
                        <p>请检查上述步骤的错误信息</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>